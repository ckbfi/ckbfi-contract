# order-contract

## **1. 项目背景**

该智能合约运行在 Nervos CKB 区块链上，主要用于实现基于用户定义代币（xUDT）。合约的设计结合了 Nervos CKB 的高性能和灵活性，支持以下功能：

- 验证用户指定的 xUDT 的流动性池。
- 验证用户交易的合法性。
- 滑点机制。
- 订单回退机制。

---

## **2. 功能模块**

### **2.1 核心功能**

1. 验证用户指定的 xUDT 的流动性池
   - 确保每笔交易都包含指定的流动性锁定脚本。
2. **交易验证**
   - 检查用户是否获得了合适的资产数量（价格计算由指定引入的流动性池负责）。
3. **滑点机制**
   - 支持用户设置滑点（`slip_point`），限制交易价格的波动范围。
   - 确保用户交易的输出资产数量不低于滑点限制计算的最低值。
4. **订单回退机制**
   - 支持用户取消订单

---

## **3. 设计细节**

### **3.1 数据结构**

- **xUDT 数据结构**
  - 每个 xUDT Cell 的数据部分为 16 字节，表示当前 Cell 中的 xUDT 数量（小端序）。

- **合约参数（args）**
  - 合约的 `args` 长度为 114 字节，分为以下部分：
    1. 前 32 字节：流动性池（bondings curve）的锁定脚本哈希。
    2. 中间 32 字节：用户账户的锁定脚本哈希。
    3. 中间 32 字节：xUDT 的 `args`，用于标识特定的 xUDT。
    4. 中间 2 字节：滑点值（`slip_point`），表示允许的价格偏差（以万分比表示）。
    5. 后 16 字节：用户期望的输出资产数量（`desired_amount`）。

- **常量**
  - `UDT_LEN`: xUDT 数据部分的长度，固定为 16 字节。

---

### **3.2 核心算法**

#### **3.2.1 参数解析**

`parse_args` 函数用于解析合约的 `args` 参数，提取以下信息：
- 流动性池的锁定脚本哈希（`bondings_curve_lock_hash`）。
- 用户账户的锁定脚本哈希（`user_lock_hash`）。
- xUDT 的参数（`xudt_args`）。
- 滑点值（`slip_point`）。
- 用户期望的输出资产数量（`desired_amount`）。

#### **3.2.2 滑点计算**

滑点机制用于限制交易价格的波动范围。计算公式如下：
$$
\text{desired\_amount\_after\_slip} = \text{desired\_amount} - \frac{\text{desired\_amount} \cdot \text{slip\_point}}{10000}
$$
- `slip_point` 表示滑点值，单位为万分比。
- `desired_amount_after_slip` 是滑点限制后的最低输出资产数量。

#### **3.2.3 用户资产统计**

`collect_xudt_amount_for_user` 函数用于统计用户账户中 xUDT 和 CKB 的数量：
1. 遍历输出中的所有 Cell。
2. 检查 Cell 的锁定脚本是否与用户账户匹配。
3. 如果是 xUDT Cell，验证其类型脚本是否匹配指定的 `xudt_args` 和 `xudt_code_hash`。
4. 如果是 CKB Cell，统计其容量值。

#### **3.2.4 流动性验证**

`check_cells_present` 函数用于检查输入中是否包含用户账户和流动性池：

1. 遍历输入中的所有 Cell。
2. 检查 Cell 的锁定脚本是否与用户账户或流动性匹配。

#### **3.2.5 交易验证逻辑**

1. 检查用户账户是否存在于输入中。如果存在，直接返回成功（订单回退逻辑）。
2. 检查指定流动性池是否存在于输入中。如果不存在，返回错误。
3. 统计用户账户的输出资产数量。
4. 验证用户账户的输出资产数量是否不低于滑点限制后的最低值。

---

### **3.3 错误处理**

- **错误类型**
  - `Error::InvalidArgs`: 参数长度不足或格式不正确。
  - `Error::MissMatchBondingsCell`: 流动性池账户缺失。
  - `Error::OutputInvalid`: 用户账户的输出资产数量不足。

---

## **4. 流程设计**

### **4.1 合约执行流程**

1. **加载脚本和参数**
   - 解析 `args` 参数，提取流动性池账户、用户账户、xUDT 参数、滑点值和期望输出资产数量。

2. **滑点计算**
   - 根据滑点值计算用户期望的最低输出资产数量。

3. **用户和流动性管理器验证**
   - 检查输入中是否包含用户账户和流动性池账户。

4. **资产统计**
   - 统计用户账户的输出资产数量。

5. **交易验证**
   - 验证用户账户的输出资产数量是否不低于滑点限制后的最低值。

6. **返回结果**
   - 若交易合法，返回 `Ok(())`。
   - 若交易不合法，返回对应的错误类型。

---

## **5. 安全性设计**

1. **防止资产盗取**
   - 验证输入和输出资产的合法性，防止用户非法提取流动性池中的资产。
2. **滑点保护**
   - 支持用户设置滑点限制，防止因价格波动导致的资产损失。
3. **账户验证**
   - 验证用户账户和流动性池账户的合法性，防止伪造账户攻击。

---

## **6. 未来扩展**

1. 支持多种类型的流动性池。
3. 引入更多的安全检查，防止复杂的攻击场景。
4. 支持限价单操作


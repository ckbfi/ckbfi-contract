# unique_liquidity_manager
## **1. 项目背景**
该合约运行在 Nervos CKB 区块链上，设计用于管理基于用户定义代币（UDT）的流动性池。主要功能包括：
- 唯一Type id管理（Type id的铸造、转移）
- 流动性统计
- 安全检查

该合约利用 Nervos CKB 的性能和灵活性，结合 xUDT 和 CKB 的流动性管理。

---

## **2. 功能模块**

### **2.1 核心功能**

1. **唯一Type id管理**
   - 验证代币的铸造、转移操作是否合法。
   - 确保交易符合合约规则。

2. **流动性统计**
   - 限制输入和输出中 xUDT 和 CKB 的数量，用于存储流动性变化。

3. **安全检查**
   - 防止流动性伪造攻击，检查交易是否符合合约规则，防止非法操作。

---

## **3. 设计细节**

### **3.1 数据结构**

- **xUDT 数据结构**
  - 每个 xUDT Cell 的数据部分为 16 字节，表示当前 Cell 中的 xUDT 数量（小端序）。

- **合约参数（args）**
  - 合约的 `args` 长度为 64 字节，分为两部分：
    1. 前 32 字节：xUDT 的 `args`，用于标识特定的 xUDT。
    2. 后 32 字节：类型 ID。

### **3.2 核心算法**

#### **3.2.1 参数解析**
解析合约的 `args`，提取 xUDT 和类型 ID 用于后续处理。

#### **3.2.2 流动性统计**
遍历输入和输出中的所有 Cell，统计input和output中流动性池的 xUDT 和 CKB 数量。

#### **3.2.3 交易验证逻辑**
1. **铸造操作**
   - 验证是否为合法的铸造操作，检查输出是否包含有效的类型 ID。
2. **转移操作**
   - 验证输入和输出的 xUDT 和 CKB 数量是否一致。

---

### **3.3 错误处理**

- **错误类型**
  - `Error::InvalidArgs`: 参数长度不正确。
  - `Error::MultipleOutputCells`: 存在多个输出type id Cell。
  - `Error::InvalidLiquidity`: 流动性验证失败。

---

## **4. 流程设计**

### **4.1 合约执行流程**

1. **加载脚本和参数**
   - 解析 `args`，提取 xUDT 和类型 ID。

2. **验证类型 ID**
   - 检查输入和输出的类型 ID 是否正确。

3. **流动性统计**
   - 统计输入和输出中的 xUDT 和 CKB 数量。

4. **交易验证**
   - 验证交易是否合法，确保流动性变化符合预期。

5. **返回结果**
   - 若交易合法，返回 `Ok(())`。
   - 若交易不合法，返回对应的错误类型。

---

## **5. 安全性设计**

1. **防止资产盗取**
   - 严格验证输入和输出的资产变化，防止非法提取池内资产。

2. **唯一Type id验证**
   - 保证经由该合约生成的cell具有唯一性，防止伪造攻击。

